<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Connor">
    <meta charset="utf-8" />
    <title>SensorTag Data</title>
    <link rel="stylesheet" href="style1.css" title="Mainly gray tbh"
          type="text/css" media="screen"/>

    <!--The below are added because I couldn't get the header background colours to reach the sides of the screen:          -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script>

        window.onload = function () {



            //Set up variables used to plot graphs
            var dps = []; // dataPoints
            var dps1 = [];
            var dps2 = [];
            var updateInterval = 5000; //5 second intervals
            var dataLength = 10; // number of dataPoints visible at any point

            var tempChart = new CanvasJS.Chart("tempChartContainer", {
                title: {
                    text: "Temperature Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                   valueFormatString:" HH:mm:ss",
                     labelAngle: -20
                },
                axisY: {
                    title: "Temperature (°C)",
                    includeZero: false
                },
                data: [{
                    type: "line",
                    dataPoints: dps,

                }]
            });

            var lightChart = new CanvasJS.Chart("lightChartContainer", {
                title: {
                    text: "Ambient Light Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                    valueFormatString:" HH:mm:ss",
                    labelAngle: -20
                },
                axisY: {
                    includeZero: false,
                    title: "Light (lux)",
                },
                data: [{
                    type: "line",
                    dataPoints: dps1
                }]
            });
            var humidityChart = new CanvasJS.Chart("humidityChartContainer", {
                title: {
                    text: "Humidity Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                    valueFormatString:" HH:mm:ss",
                    labelAngle: -20
                },
                axisY: {

                    includeZero: false,
                    title: "Humidity (%rH)",
                },
                data: [{
                    type: "line",
                    dataPoints: dps2
                }]
            });


            //Function to update the temperature chart with new data
            var updateTempChart = function (count,temp) {

                count = count || 1;

                var time = new Date();
                xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());

                  for (var j = 0; j < count; j++) {

                      dps.push({
                              x: xVal,
                              y: temp
                          }
                      );
                  }

                  if (dps.length > dataLength) {
                      dps.shift();
                  }
                  tempChart.render();

            };

            //Function to update the light chart with new data

            var updateLightChart = function (count,light) {

                count = count || 1;

                var time = new Date();
                xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());


                    for (var j = 0; j < count; j++) {

                        dps1.push({
                                x: xVal,
                                y: light
                            }
                        );

                    }

                    if (dps1.length > dataLength) {
                        dps1.shift();
                    }

                    lightChart.render();

            };


            //Function to update the humidity chart with new data

            var updateHumidityChart = function (count,humid) {

                count = count || 1;

                var time = new Date();
                xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());

                for (var j = 0; j < count; j++) {

                    dps2.push({
                            x: xVal,
                            y: humid
                        }
                    );
                }
                if (dps2.length > dataLength) {
                    dps2.shift();
                }
                humidityChart.render();

            };
            // function updateDataLength(){
            //     if(dataLength<20)
            //         dataLength++;
            // }
          //  setInterval(updateDataLength,updateInterval);

            //Gets the temperature data and saves it
            function getTemp(){
                xhttp1 = new XMLHttpRequest();
                xhttp1.onreadystatechange = function() {

                    if (xhttp1.readyState == 4 && xhttp1.status == 200) {
				if(xhttp1.responseText == ";"){
			updateTempChart(10, 0);
			document.getElementById("myTemp").innerHTML = "No temperature to display";
			document.getElementById("message").innerHTML = "Sensortag must be off.";
		}

		else{

		updateTempChart(10,parseFloat(xhttp1.responseText));
       document.getElementById("myTemp").innerHTML = xhttp1.responseText.replace(";", "") + " °C";
	   }
	   }
                };
                xhttp1.open("GET", "https://conrfield.com:1880/getTemp", true);
                xhttp1.send();

            }

            //Gets the light data and saves it
            function getLight(){
                xhttp2 = new XMLHttpRequest();
                xhttp2.onreadystatechange = function() {
                    if (xhttp2.readyState == 4 && xhttp2.status == 200) {
					   // Typical action to be performed when the document is ready:
	   if(xhttp2.responseText == ";"){
	   updateLightChart(10, 0);
			document.getElementById("myLight").innerHTML = "No light to display";
		}
		else{
		updateLightChart(10,parseFloat(xhttp2.responseText));
       document.getElementById("myLight").innerHTML = xhttp2.responseText.replace(";", "") + " Lux";
	   }
                    }
                };
                xhttp2.open("GET", "https://conrfield.com:1880/getLight", true);
                xhttp2.send();
            }

            //Gets the humidity data and saves it
            function getHumidity(){
                xhttp3 = new XMLHttpRequest();
                xhttp3.onreadystatechange = function() {
                    if (xhttp3.readyState == 4 && xhttp3.status == 200) {


if(xhttp3.responseText == ";"){
		 // Typical action to be performed when the document is ready:
                        updateHumidityChart(10,0);
			document.getElementById("myHumidity").innerHTML = "No humidity to display";
		}
		else{
		 // Typical action to be performed when the document is ready:
                        updateHumidityChart(10,parseFloat(xhttp3.responseText));
        document.getElementById("myHumidity").innerHTML = xhttp3.responseText.replace(";", "") + " %rH";
	   }
                    }
                };
                xhttp3.open("GET", "https://conrfield.com:1880/getHumidity", true);
                xhttp3.send();
            }

            getTemp();
            setInterval(getTemp,updateInterval);
            getLight();
            setInterval(getLight,updateInterval);
            getHumidity();
            setInterval(getHumidity,updateInterval);

        }

    </script>

</head>
<body>

<h1>
    <a href="index.html" style="vertical-align: middle;">
        <img class="arrow imgGH" src="img/arrow-left.svg" alt="Back Arrow" >
    </a>
    SensorTag Data

</h1>
<p>Any temperature, light or humidity data was taken from the sensortag with device ID <i>987bf3131f23</i></p>
<p>The immediately below results will update every 5 seconds to show data at that instance, if the sensortag is on. If the SensorTag is turned off then
    the last recieved data values will continue to be displayed.</p>

<h2 class="noUpDownMargin"> Current Temperature: </h2>
<p>	<div class="noUpDownMargin" id="myTemp">Temperature placeholder </div> </p>
<h2 class="noUpDownMargin"> Current Light: </h2>
<p> <div class="noUpDownMargin" id="myLight">Light placeholder</div>  </p>
<h2 class="noUpDownMargin"> Current Humidity: </h2>
<p> <div class="noUpDownMargin" id="myHumidity">Humidity placeholder</div> </p>

<b><p id="message"></p></b>
<p>Below are graphical representations of the greenhouse conditions:<br><p>

    <div class="margin">
<p><div id="tempChartContainer" style="height: 40vw; width: 80vw;"></div></p>
<p><div id="lightChartContainer" style="height: 40vw; width:  80vw;"></div></p>
<p><div id="humidityChartContainer" style="height: 40vw; width:  80vw;"></div></p>
<div>

</body>
</html>