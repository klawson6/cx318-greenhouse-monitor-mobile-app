<!DOCTYPE html>
<html>
<head>
    <title>SensorTag Data Graphs</title>
    <link rel="stylesheet" href="style1.css" title="Mainly gray tbh"
          type="text/css" media="screen"/>

    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script>

        // getTemp();
        // getLight();
        // getHumidity();

        //Global variables for the data
        var temp = 0;
        var light = 0;
        var humidity = 0;


        window.onload = function () {


            //Set up variables used to plot graphs
            var dps = []; // dataPoints
            var dps1 = [];
            var dps2 = [];
           var xVal = 0;
            var updateInterval = 3000;
            var dataLength = 20; // number of dataPoints visible at any point

            var tempChart = new CanvasJS.Chart("tempChartContainer", {
                title: {
                    text: "Temperature Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                   valueFormatString:" HH:mm:ss",
                     labelAngle: -20
                },
                axisY: {
                    title: "Temperature",
                    includeZero: false
                },
                data: [{
                    type: "line",
                    dataPoints: dps,
                   // xValueFormatString: "hh:mm:ss",
                }]
            });

            var lightChart = new CanvasJS.Chart("lightChartContainer", {
                title: {
                    text: "Ambient Light Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                    valueFormatString:" HH:mm:ss",
                    labelAngle: -20
                },
                axisY: {
                    includeZero: false,
                    title: "Light",
                },
                data: [{
                    type: "line",
                    dataPoints: dps1
                }]
            });
            var humidityChart = new CanvasJS.Chart("humidityChartContainer", {
                title: {
                    text: "Humidity Data"
                },
                axisX:{
                    title: "Time (h:m:s)" ,
                    gridThickness: 2,
                    valueFormatString:" HH:mm:ss",
                    labelAngle: -20
                },
                axisY: {
                    includeZero: false,
                    title: "Humidity",
                },
                data: [{
                    type: "line",
                    dataPoints: dps2
                }]
            });


            //Function to update the temperature chart with new data
            var updateTempChart = function (count) {

                count = count || 1;

                var time = new Date();
               xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());

                var  yVal = getTemp();

              if(yVal !== null) {
                  for (var j = 0; j < count; j++) {

                      dps.push({
                              x: xVal,
                              y: yVal
                          }
                      );

                  }

                  if (dps.length > dataLength) {
                      dps.shift();
                  }


                  tempChart.render();
             }
            };

            //Function to update the light chart with new data

            var updateLightChart = function (count) {

                count = count || 1;

                var time = new Date();
                xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());

                for (var j = 0; j < count; j++) {

                    dps1.push({
                            x: xVal,
                            y: getLight()
                        }
                    );

                }

                if (dps1.length > dataLength) {
                    dps1.shift();
                }

                lightChart.render();
            };


            //Function to update the humidity chart with new data

            var updateHumidityChart = function (count) {

                count = count || 1;

                var time = new Date();
                xVal = new Date(time.getFullYear(),time.getMonth(),time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());

                for (var j = 0; j < count; j++) {

                    dps2.push({
                            x: xVal,
                            y: getHumidity()
                        }
                    );

                }

                if (dps2.length > dataLength) {
                    dps.shift();
                }

                humidityChart.render();
            };

            updateTempChart(dataLength);
            setInterval(function () {updateTempChart()}, updateInterval);

            updateLightChart(dataLength);
            setInterval(function () {updateLightChart()}, updateInterval);

            updateHumidityChart(dataLength);
            setInterval(function () {updateHumidityChart()}, updateInterval);

            setInterval(function () {
                if(dataLength<20)
                    dataLength++;
            },updateInterval)


        }


        //Gets the temperature data and saves it
        function getTemp(){
            xhttp1 = new XMLHttpRequest();
            xhttp1.onreadystatechange = function() {
                if (xhttp1.readyState == 4 && xhttp1.status == 200) {

                    //temp = xhttp1.responseText;

                    temp = temp+1;
                }
            };
            xhttp1.open("GET", "https://conrfield.com:1880/getTemp", true);
            xhttp1.send();
            return temp;
        }

        //Gets the light data and saves it
        function getLight(){
            xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
                if (xhttp2.readyState == 4 && xhttp2.status == 200) {
                    // Typical action to be performed when the document is ready:
                    //  light = xhttp2.responseText;
                    light = light+1;
                }
            };
            xhttp2.open("GET", "https://conrfield.com:1880/getLight", true);
            xhttp2.send();
            return light;
        }

        //Gets the humidity data and saves it
        function getHumidity(){
            xhttp3 = new XMLHttpRequest();
            xhttp3.onreadystatechange = function() {
                if (xhttp3.readyState == 4 && xhttp3.status == 200) {
                    // Typical action to be performed when the document is ready:
                    //  humidity = xhttp3.responseText;
                    humidity = humidity+1;
                }
            };
            xhttp3.open("GET", "https://conrfield.com:1880/getHumidity", true);
            xhttp3.send();
            return humidity
        }


    </script>

</head>
<body>

<h1>
    SensorTag Data Graphs!
</h1>

<p><div id="tempChartContainer" style="height: 300px; width: 100%;"></div></p>
<p><div id="lightChartContainer" style="height: 300px; width: 100%;"></div></p>
<p><div id="humidityChartContainer" style="height: 300px; width: 100%;"></div></p>



</body>